<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login via Helios API</title>
    <script src="assets/js/anime.min.js"></script>
    <link rel="stylesheet" href="assets/css/index.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="apple-touch-icon" sizes="144x144" href="../meta/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../meta/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../meta/favicon-16x16.png">
    <link rel="manifest" href="../meta/site.webmanifest">
    <link rel="mask-icon" href="../meta/safari-pinned-tab.svg" color="#5bbad5">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="theme-color" content="#ffffff">

<!--    Google Sign-in-->
    <meta name="google-signin-client_id" content="835400034288-9ml5qeqd6ciis356v1s995345f5cbirn.apps.googleusercontent.com">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

</head>
<body>

<div class="page">
    <div class="container">
        <div class="left">
            <div class="eula">
                <div id="my-signin2"></div>
                <div style="height:50px;width:240px;margin-top: 5px" onclick="">
                    <div class="abcRioButton abcRioButtonBlue">
                        <div class="abcRioButtonContentWrapper">
                            <div class="abcRioButtonIcon" style="padding: 15px">
                                <div style="width:18px;height:18px;color: #597da3;font-size: 20px" class="abcRioButtonSvgImageWithFallback abcRioButtonIconImage abcRioButtonIconImage18">
                                    <i class="fa fa-vk abcRioButtonSvg" ></i>
                                </div>

                            </div>

                            <span style="font-size:16px;line-height:48px;" class="abcRioButtonContents">
                                Sign in with Vkontakte
                            </span>
                        </div>

                    </div>
                </div>
                <br>Если у Вас нет аккаунта <a href="register.html">зарегистрируйтесь</a>
            </div>
        </div>
        <div class="right">
            <svg viewBox="0 0 320 300" class="svg-form">
                <defs>
                    <linearGradient
                            id="linearGradient"
                            x1="13"
                            y1="193.49992"
                            x2="307"
                            y2="193.49992"
                            gradientUnits="userSpaceOnUse">
                        <stop
                                style="stop-color:#ff00ff;"
                                offset="0"
                                id="stop876"></stop>
                        <stop
                                style="stop-color:#ff0000;"
                                offset="1"
                                id="stop878"></stop>
                    </linearGradient>
                </defs>
                <path class="path-form" d="m 40,120.00016 240.99984,-3.1e-4
                c 0,0 24.99263,0.79932 25.00016,35.00016 0.008,34.20084 -25.00016,35 -25.00016,35
                h -239.99984
                c 0,-0.0205 -25,4.01348 -25,38.5 0,34.48652 25,38.5 25,38.5
                h 215 c 0,0 20,-0.99604 20,-25 0,-24.00396 -20,-25 -20,-25
                h -190
                c 0,0 -20,1.71033 -20,25 0,24.00396 20,25 20,25
                h 168.57143"></path>
            </svg>
            <form class="form">
                <div style="color: red; position: fixed; top: 65px" id="invalid-auth" hidden>Неверный логин или пароль</div>
                <label for="username">Username</label>
                <input  class="type-input" name="login" autocomplete="username" type="text" id="username">
                <label for="password" id="password-label">Password</label>
                <input class="type-input" type="password" autocomplete="current-password" id="password" name="password">
                <input type="button"
                       id="submit" value="Submit" onclick="onSubmitClick()">


            </form>


        </div>
    </div>
</div>
<script>
    function onSubmitClick(){
                let username = document.querySelector("#username").value;
                let password = document.querySelector("#password").value;

                fetch(`/api/auth?login=${username}&password=${password}`)
                    .then(response => {
                        if (response.status === 200){
                            document.location.href = "/helios.html"
                        } else if (response.status === 401) {
                            document.querySelector("#invalid-auth").innerHTML = "Неверный логин или пароль";
                            document.querySelector("#invalid-auth").removeAttribute("hidden");
                        } else {
                            document.querySelector("#invalid-auth").innerHTML = "Ошибка. <br> Повторите попытку позже";
                            document.querySelector("#invalid-auth").removeAttribute("hidden");
                        }
                    })
    }
</script>
<!--Google Script-->

<script>
    function onSuccess(googleUser) {
        console.log('Logged in as: ' + googleUser.getBasicProfile().getEmail());
        fetch("/api/google/oauth?email=" + window.btoa(googleUser.getBasicProfile().getEmail()), {
            "method" : 'put'
        })
            .then(response => {
                if (response.status === 200){
                    document.location.href = "/helios.html";
                } else if (response.status === 404){
                    document.location.href = "/external/register.html#" + googleUser.getBasicProfile().getEmail();
                } else {
                    console.log(response.status);
                }
            });
    }
    function onFailure(error) {
        console.log(error);
    }
    function renderButton() {
        gapi.signin2.render('my-signin2', {
            'scope': 'profile email',
            'width': 240,
            'height': 50,
            'longtitle': true,
            'theme': 'dark',
            'onsuccess': onSuccess,
            'onfailure': onFailure
        });
    }

    function vkAuth(){
        document.location.href = ""
    }

</script>

<script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>



<script>
    var current = null;
    document.querySelector('#username').addEventListener('focus', function (e) {
        if (current) current.pause();
        current = anime({
            targets: 'path',
            strokeDashoffset: {
                value: 0,
                duration: 700,
                easing: 'easeOutQuart'
            },
            strokeDasharray: {
                value: '240 1386',
                duration: 700,
                easing: 'easeOutQuart'
            }
        });
    });
    document.querySelector('#password').addEventListener('focus', function (e) {
        if (current) current.pause();
        current = anime({
            targets: 'path',
            strokeDashoffset: {
                value: -336,
                duration: 700,
                easing: 'easeOutQuart'
            },
            strokeDasharray: {
                value: '240 1386',
                duration: 700,
                easing: 'easeOutQuart'
            }
        });
    });
    document.querySelector('#submit').addEventListener('focus', function (e) {
        if (current) current.pause();
        current = anime({
            targets: 'path',
            strokeDashoffset: {
                value: -730,
                duration: 700,
                easing: 'easeOutQuart'
            },
            strokeDasharray: {
                value: '530 1386',
                duration: 700,
                easing: 'easeOutQuart'
            }
        });
    });
</script>
</body>
</html>